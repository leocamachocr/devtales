---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const tales = await getCollection('tales');
  const posts = await getCollection('posts');
  const allContent = [...tales, ...posts];
  
  // Get all unique tags
  const allTags = new Set();
  allContent.forEach(item => {
    if (item.data.tags) {
      item.data.tags.forEach(tag => allTags.add(tag));
    }
  });
  
  // Create routes for each tag
  return Array.from(allTags).map((tag) => ({
    params: { slug: tag as string },
    props: { 
      tag: tag as string, 
      content: allContent.filter(item => 
        item.data.tags && item.data.tags.includes(tag as string)
      )
    },
  }));
}

const { tag, content } = Astro.props;
---

<Layout 
  title={`#${tag} - DevTales`}
  description={`All posts and tales tagged with #${tag} on DevTales`}
>
  <div class="tag-page">
    <h1>#{tag}</h1>
    <p>{content.length} content{content.length !== 1 ? 's' : ''} found</p>
    
    <div class="content-grid">
      {content.map((item) => (
        <article class="card">
          {item.data.image && (
            <div class="card-thumbnail">
              <img 
                src={item.data.image} 
                alt={item.data.imageAlt || item.data.title}
                loading="lazy"
              />
            </div>
          )}
          <div class="card-content">
            <h3>
              <a href={`/devtales/${item.collection}/${item.slug}/`}>
                {item.data.title}
              </a>
            </h3>
            <p class="card-meta">
              <time>{item.data.date.toDateString()}</time>
              {item.data.author && <span> â€¢ by {item.data.author}</span>}
            </p>
            <p class="card-description">{item.data.description}</p>
            <div class="card-tags">
              {item.data.tags && item.data.tags.slice(0, 3).map((itemTag) => (
                <span class="tag">#{itemTag}</span>
              ))}
            </div>
          </div>
        </article>
      ))}
    </div>
  </div>
</Layout>
